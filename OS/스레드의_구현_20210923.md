[목록](https://github.com/JungInBaek/TIL/blob/main/README.md)

# 스레드의 구현
스레드는 운영체제에 따라 다양하게 구현할 수 있다. 대부분 다음 세 가지 형태로 구현한다.
- 사용자 수준 스레드(user-level thread : 다대일(n : 1) 매핑)
- 커널 수준 스레드(kernel-level thread : 일대일(1 : 1) 매핑)
- 혼합형 스레드(multiplexed thread : 다대다(n : m) 매핑)

## 1. 사용자 수준 스레드
사용자 수준 스레드는 사용자 영역의 스레드 라이브러리로 구현하고, 스레드와 관련된 모든 행위를 사용자 영역에서 하므로 커널이 스레드의 존재를 모른다. 사용자 수준 스레드에서는 스레드 교환에 커널이 개입하지 않아 커널에서 사용자 영역으로 전환할 필요가 없다.

사용자 영역에서 스레드를 구현하면 커널에서 스레드를 지원할 필요가 없어 다음 장점이 있다.
- 이식성이 높음 : 커널에 독립적으로 스케줄링을 할 수 있어 모든 운영체제에 적용할 수 있다.
- 오버헤드가 적음 : 스케줄링이나 동기화를 하려고 커널을 호출하지 않으므로 커널 영역으로 전환하는 오버헤드가 줄어든다.
- 유연한 스케줄링이 가능 : 커널이 아닌 스레드 라이브러리에서 스레드 스케줄링을 제어하므로 응용 프로그램에 맞게 스케줄링을 할 수 있다.

반면에 사용자 수준 스레드를 이용하면 다음 단점이 있다.
- 시스템의 동시성을 지원하지 않음 : 스레드가 아닌 프로세스 단위로 프로세서를 할당하여 다중 처리 환경을 갖춰도 스레드 단위로 다중 처리를 하지 못한다. 동일한 프로세스의 스레드 한 개가 대기 상태가 되면 이 중 어떤 스레드도 실행하지 못한다.
- 확장에 제약이 따름 : 커널이 한 프로세스에 속한 여러 스레드에 프로세서를 동시에 할당할 수 없어 다중 처리 시스템에서 규모를 확장하기가 어렵다.
- 스레드 간 보호 불가능 : 스레드 간 보호에 커널의 보호 방법을 사용할 수 없다. 스레드 라이브러리에서 스레드 간 보호를 제공해야 프로세스 수준에서 보호가 가능하다.

## 2. 커널 수준 스레드
커널 수준 스레드는 커널이 스레드와 관련된 모든 작업을 관리한다. 한 프로세스에서 다수의 스레드가 프로세서를 할당받아 병행으로 수행하고, 스레드 한 개가 대기 상태가 되면 동일한 프로세스에 속한 다른 스레드로 교환이 가능하다. 이 때 커널이 개입하므로 사용자 영역에서 커널 영역으로 전환이 필요하다. 커널 수준 스레드에서는 사용자 수준 스레드와 커널 수준 스레드가 일대일(1 : 1)로 매핑된다. 따라서 사용자 수준 스레드를 생성하면 이에 대응하는 커널 수준 스레드를 자동으로 생성한다.

커널 수준 스레드는 커널이 직접 스케줄링하고 실행하기에 사용자 수준 스레드의 커널 지원이 부족한 문제를 해결할 수 있지만, 커널이 전체 프로세스와 스레드 정보를 유지하여 오버헤드가 커진다. 대신 커널이 각 스레드를 개별적으로 관리할 수 있어 동일한 프로세스의 스레드들을 병행으로 수행할 수 있다. 동일한 프로세스에 있는 스레드 중 한 개가 대기 상태가 되더라도 다른 스레드를 실행할 수 있다는 장점이 있다. 하지만 이 과정에서도 커널 영역으로 전환하는 오버헤드가 발생하고 스케줄링과 동기화를 하려면 더 많은 자원이 필요하다.

## 3. 혼합형 스레드
혼합형 스레드는 사용자 수준 스레드와 커널 수준 스레드를 혼합한 구조이다. 사용자 수준 스레드는 커널 수준 스레드와 비슷한 경량 프로세스(LWP)에 다대다(n : m)로 매핑되고, 경량 프로세스는 커널 수준 스레드와 일대일(1 : 1)로 매핑된다. 결국 다수의 사용자 수준 스레드에 다수의 커널 스레드가 다대다(n : m)로 매핑된다.

프로세스 하나에는 경량 프로세스가 하나 이상 있고, 경량 프로세스에는 이에 대응하는 커널 스레드가 한 개 있다. 그리고 자원과 입출력 대기를 하려고 경량 프로세스 단위로 대기하므로 프로세스는 입출력을 완료할 때까지 대기할 필요가 없다. 어떤 경량 프로세스가 입출력 완료를 기다리더라도 동일한 프로세스에서 다른 경량 프로세스를 실행할 수 있기 때문이다.

혼합형 스레드는 라이브러리가 최적의 성능을 지원하도록 커널이 경량 프로세스 수를 동적으로 조절하여 사용자 수준 스레드와 커널 수준 스레드가 다대다(n : m)로 매핑된다. 그리고 커널 영역에서 병렬 처리 정도를 이 매핑이 결정할 수 있어 병행 실행이 의미가 없을 때는 다대일(n : 1) 매핑도 사용할 수 있다. 그리고 스레드 풀링을 이용하여 일대일(1 : 1) 매핑으로 오버헤드를 줄일 수 있다.