[목록](https://github.com/JungInBaek/TIL/blob/main/README.md)

# 스레드의 개념과 상태 변화

## 1. 스레드의 개념
프로세스는 두 가지 특성인 자원과 제어로 구분할 수 있다. 이 중 제어만 분리한 실행 단위를 스레드(thread)라고 하는데, 프로세스 하나는 스레드 한 개 이상으로 나눌 수 있다. 스레드들은 프로그램 카운터와 스택 포인터 등을 비롯한 스레드 실행환경 정보(문맥 정보), 지역 데이터, 스택을 독립적으로 가지면서 코드, 전역 데이터, 힙을 다른 스레드와 공유한다.

스레드 중에서 프로세스의 속성 중 일부가 들어 있는 것을 경량 프로세스(LWP, Light Weight Process)라고 한다. 반대로 스레드 하나에 프로세스 하나인 전통적인 경우를 중량 프로세스(HWP, Heavy Weight Process)라고 한다.

스레드를 이용하면 다음 이점이 있다.
- 사용자 응답성 증가 : 응용 프로그램의 일부분을 봉쇄하거나 긴 작업을 수행하더라도 병렬 프로그래밍으로 프로그램을 계속 실행할 수 있어 사용자 응답성이 증가한다.
- 프로세스의 자원과 메모리 공유 가능 : 스레드들이 프로세스 자원 하나와 메모리를 공유하므로 응용프로그램 하나가 동일한 주소 공간에서 스레드를 여러 개 실행하여 시스템 성능을 향상시킬 수 있다.
- 경제성이 좋음 : 프로세스를 생성하는 것보다 스레드를 생성하여 문맥을 교환하면 오버헤드가 줄어든다.
- 다중 처리(멀티 프로세싱)로 성능과 효율 향상 : 각 스레드를 여러 프로세서에서 병렬로 실행하여 성능과 효율성을 높일 수 있다.

## 2. 단일 스레드와 다중(멀티) 스레드
운영체제는 단일 프로세스에서 단일 스레드 실행이나 다중 스레드 실행을 지원한다. 단일 스레드를 지원하는 운영체제는 프로세스 하나에 스레드 한 개를 실행하는 전통적인 방법으로 아직 스레드 용어가 탄생하기 전이라 개념이 불확실하다. 도스가 대표적인 예이다.

현대 운영체제는 대부분 다중 스레드이다. 다중 스레드는 프로그램 하나를 여러 실행 단위로 쪼개어 실행한다는 측면에서 다중 처리(다중 프로세싱)와 의미가 비슷하다. 하지만 동일 프로세스의 스레드는 자원을 공유하므로 자원 생성과 관리의 중복성을 최소화하여 실행 능력을 향상시킬 수 있다. 그리고 각 스레드는 커널이 개입하지 않고도 독립적으로 실행할 수 있어 서버에서 많은 요청을 효과적으로 처리할 수 있다.

## 3. 스레드의 사용 예
현대 운영체제에서 수행하는 많은 프로그램은 다중 스레드를 지원하여 스레드의 개념을 사용자 수준에서 적용할 수 있다. 그리고 프로그램의 비동기적 요소를 구현하는 데 사용할 수도 있다. 특히 스레드를 사용자 수준에서 적용하면 운영체제와 무관하므로 속도가 매우 빠르다. 또 현재 실행 중인 스레드를 대기 상태로 바꾸고 제어를 다른 스레드로 옮기는 상태 변화를 이용하여 많은 요청을 효과적으로 처리할 수도 있다. 공유 메모리가 있는 다중 처리 시스템에서는 프로그램을 공유 메모리에 저장하고 각 프로세서에 스레드를 할당하여 병렬로 처리하면 성능을 월등히 향상시킬 수 있다.
하지만 스레드는 단점이 있다. 사용자 수준 스레드는 커널 자체가 스레드 한 개로 구성되어 스레드에서 시스템 호출을 실행하면 전체 작업이 이 시스템의 호출 결과를 받을 때까지 기다려야 한다.

## 4. 스레드의 상태 변화
스레드와 프로세스는 공통점이 상당히 많다. 프로세스처럼 준비, 실행, 대기(보류), 종료 상태가 있다. 스레드는 프로세서를 함께 사용하고 항상 하나만 실행한다. 또 한 프로세스에 있는 스레드는 순차적으로 실행하고, 해당 스레드의 정보를 저장하는 레지스터와 스택이 있다. 

보통 프로세스를 생성하면 해당 프로세스의 스레드도 함께 생성한다. 단 스레드 생성에서는 운영체제가 부모 프로세스와 공유할 자원을 초기화할 필요가 없다. 해당 프로세스가 스택과 레지스터를 제공하기 때문이다. 그러므로 프로세스의 생성과 종료보다는 오버헤드가 훨씬 적다.

여기서 스레드의 장점 하나는 스레드 한 개가 대기 상태로 변할 때 전체 프로세스를 대기 상태로 바꾸지 않는다는 것이다. 실행 상태의 스레드가 대기 상태가 되면 다른 스레드를 실행할 수 있다. 그러나 프로세스와 달리 서로 독립적이지는 않다. 따라서 보호 문제가 발생할 수 있지만 크게 염려하지 않아도 된다. 프로세서는 여러 사용자가 생성하여 서로 경쟁적으로 자원을 요구하고 서로 다른 관계를 유지해야 하지만, 스레드는 사용자 한 명이 여러 스레드로 개인 프로세스 하나를 소유하기 때문이다.

## 5. 스레드의 제어 블록
스레드 제어 블록은 프로세스 제어 블록과 마찬가지로 레지스터 값, 프로그램 카운터, 스택 포인터, 스케줄링 상태 외에도 스레드 ID와 해당 스레드를 포함하는 프로세스 포인터 같은 특정 값도 저장한다. 스레드 간에 보호는 하지 않는다. 다음은 TCB의 내용이다.
- 실행 상태 : 프로세서 레지스터, 프로그램 카운터, 스택 포인터
- 스케줄링 정보 : 상태(실행, 준비, 대기), 우선순위, 프로세서 시간
- 계정 정보
- 스케줄링 큐용 다양한 포인터
- 프로세스 제어 블록(PCB)을 포함하는 포인터